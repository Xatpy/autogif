<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<script type="text/javascript" src="./libgif/libgif.js"></script>
		<script type="text/javascript" src="./libgif/rubbable.js"></script>
		<script type="text/javascript" src="./noUiSlider/nouislider.min.js"></script>

<link rel="stylesheet" type="text/css" href="./noUiSlider/nouislider.min.css">

		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">

		<title>
			Auto gif
		</title>

		<script src="./jsgif/b64.js"></script>
		<script src="./jsgif/LZWEncoder.js"></script>
		<script src="./jsgif/NeuQuant.js"></script>
		<script src="./jsgif/GIFEncoder.js"></script>

		<style>
			#loading {	position:fixed;
			    top: 50%;
			    left: 50%;
			    width: 30em;
			    height: 18em;
			    margin-top: -9em; 
			    margin-left: -15em; 
			    border: 1px solid #ccc;
			    background-color: #f3f3f3;
			}
			#loading-image { position: absolute; top: 40%; left: 45%; z-index: 100} 
		</style>

	</head>

	<body>

		<center>

			<div id="inputDiv">
				<h1>Input</h1>
				<input type="file" id="files" name="files[]" multiple/>
				<div id="listInputImg"></div>
				<button onclick="resize(true)">+</button>
				<button onclick="resize(false)">-</button>
			</div>

			<div id="divModifyGif">
				<div id="inputGif">
					<h1>Record the gif</h1>
					<button onclick="createGif()">Crear gif</button>
					<br> <br>
					<img id="canvas_libgif" rel:animated_src="./assets/kP.gif" rel:auto_play="0" width="467" height="375" style="display:none;"/>
					<br>
					<a href="javascript:;" onmousedown="sup1.pause(); return false;">Pause</a> |
					<a href="javascript:;" onmousedown="sup1.play(); return false;">Play</a> |
					<a href="javascript:;" onmousedown="sup1.move_to(0); return false;">Restart</a> |
					<a href="javascript:;" onmousedown="sup1.move_relative(1); return false;">Step forward</a> |
					<a href="javascript:;" onmousedown="sup1.move_relative(-1); return false;">Step back</a> | 
					<a href="javascript:;" onmousedown="recording()">Record</a>
				</div>
		</center>
				<div id="preview">
					<h2>Preview</h2>
					<canvas id="myCanvas" width="320" height="233" style=";"></canvas>
					<div id="slider"></div>
					<div id="slider-range-value"></div>

				</div>
			</div>
			<div id="divResult">
				<h1>Output</h1>
				<img id="image" width="320" height="233">
			</div>

			<div id="loading">
				<br><br>
				<h2>Loading...</h2>
				<!--<img id="loading-image" src="./assets/loading.gif" alt="Loading..." />-->
			</div>  

			<script type="text/javascript">

				//-------------- Globals variables --------------
				var selectedImageInput = 1;
				var sup1;

				// -------------- Functions --------------

				window.onload = function(){
					showLoadingSpinner(false);
				}

				sup1 = new SuperGif({ gif: document.getElementById('canvas_libgif') } );
				sup1.load(function hola() { 
					createSlider(sup1.get_length());
					var canvas = document.getElementById('cabesa');
					drawImageInCanvas(sup1.get_canvas());
					canvas.addEventListener("mousedown", function(evt) {
						getPosition(evt, 'cabesa') },false); 
					var canvasPreview = document.getElementById('myCanvas');
					canvasPreview.addEventListener("mousedown", function(evt) {
						getPosition(evt, 'myCanvas') },false);
					document.getElementById("cabesa").style.display = "none"
					});

				document.getElementById("cabesa").style.display = "none"

				var recordedSteps = [];
				var isRecording = false;

				function createGif(){

					var c=document.getElementById("myCanvas");
    				var ctx=c.getContext("2d");
    				var img = document.getElementById('cabesa');

					var encoder = new GIFEncoder();
					encoder.setRepeat(0); //auto-loop
					encoder.setDelay(10);
					console.log(encoder.start());

    				var data = [];
    				var len = sup1.get_length();

					showLoadingSpinner(true);

    				function addImageToGif(i) {
    					sup1.move_to(i);
    					data.push(sup1.get_canvas());
    					ctx.drawImage(sup1.get_canvas(),0,0);
    					if (i < recordedSteps.length) 
    					{
							var img = document.getElementById(recordedSteps[i].image);
							ctx.drawImage(img, recordedSteps[i].pos.x, recordedSteps[i].pos.y, 
												recordedSteps[i].width, recordedSteps[i].height);
    					}    					
						encoder.addFrame(ctx);
    				}

    				function gifCreated() {
						console.log("se acaboooooo");
			        	encoder.finish();
						document.getElementById('image').src = 'data:image/gif;base64,'+ encode64(encoder.stream().getData());
						showLoadingSpinner(false);
    				}

    				var i = 0;
    				// Reference: http://blog.jeremyaldrich.net/en/latest/nonblocking_forloop_javascript.html
					function loopCreateGifWithoutBlocking(i) {
					    addImageToGif(i);
					    if (i < len) {
					        setTimeout(function() { loopCreateGifWithoutBlocking( i + 1); }, 5);
					    } else {
					    	gifCreated();
					    }
					};
					loopCreateGifWithoutBlocking(i);
    				
				}

				function getPosition(evt, canvasId)
				{
					var canvas = document.getElementById(canvasId);
					var mousePos = getMousePos(canvas, evt);

					var position = {};
					var img = document.getElementById(selectedImageInput);
					if (img === null) {
						alert('No input images selected');
						return;
					}

					position.x = mousePos.x - (img.width / 2);
					position.y= mousePos.y - (img.height / 2);

					if (!isRecording)
					{
						//alert("NOT RECORDING!");
						overlap(position);
						return;
					}
 
 					// 25 = 50 / 2; 50 is the hardcoded value when we draw
 					var step =  {  pos: position , image: selectedImageInput, width: img.width , height : img.height }
					recordedSteps.push( step );
					sup1.move_relative(1);
				}

				function overlap(position)
				{
					var c=document.getElementById("myCanvas");
    				var ctx=c.getContext("2d");
					var img = document.getElementById(selectedImageInput);

					if (img === null) {
						alert("img is null. Select one image");
						return;
					}

					ctx.drawImage(sup1.get_canvas(),0,0);
					ctx.drawImage(img, position.x, position.y, img.width, img.width);  
				}

				function drawImageInCanvas(canvas)
				{
					var c=document.getElementById("myCanvas");
    				var ctx=c.getContext("2d");
					ctx.drawImage(canvas,0,0);
				}

				function recording()
				{
					sup1.move_to(0); 
					isRecording = true;

					return false;
				}

				function getMousePos(canvas, evt) {
					var rect = canvas.getBoundingClientRect();
					return {
						x: evt.clientX - rect.left,
						y: evt.clientY - rect.top
					};
				}

				// Function to select the input image that will be overwrite
				function selectInput(e)
				{
					debugger
					var newInput = e.target ? e.target.id : e.srcElement.id;

					if (newInput === selectedImageInput){
						return;
					}
					selectedImageInput = newInput;

					var childs = document.getElementById("listInputImg").childNodes;
					if (childs !== null) {
						for (var i = 0; i < childs.length; ++i) {
							var tempId = childs[i].childNodes[0].id;
							if (tempId === selectedImageInput) {
								childs[i].childNodes[0].style.border = "solid #0000FF 10px";
							} else{
								childs[i].childNodes[0].style.border = "none";
							}
						}
					}
				}

			    // ------------ INPUT
				function handleFileSelect(evt) {
					var files = evt.target.files; // FileList object

					// files is a FileList of File objects. List some properties.
			      	var num = 0;

					var output = [];
					for (var i = 0, f; f = files[i]; i++) {
					  // Only process image files.
				      if (!f.type.match('image.*')) {
				        continue;
				      }

				      var reader = new FileReader();
				        num += 1;

				      // Closure to capture the file information.
				      reader.onload = (function(theFile, num) {
		        		
				        return function(e) {
				          var span = document.createElement('span');
				          span.innerHTML = ['<img class="thumb" src="', e.target.result,
				                            '" title="', escape(theFile.name), 
				                            '" style=" max-height: 200px; max-width: 200px;',
				                            'margin: 50px',
				                            '" id="inputImg_', num.toString(),'"/>' 
				                            ].join('');
				          span.addEventListener('mousedown', selectInput, false);
				          document.getElementById('listInputImg').insertBefore(span, null);
				        };
				        console.log('a');
				      })(f, num);

				      // Read in the image file as a data URL.
				      reader.readAsDataURL(f);
					}
					//document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
				}

				function resize(mode) {
					var img = document.getElementById(selectedImageInput);
					if (img === null || img === undefined) {
						alert("Select any image input");
						return
					}

					if (mode) {
						img.width += 10;
					}
					else {
						if (img.width > 10) {
							img.width -= 10;							
						}
					}
				}

				function showLoadingSpinner(value) {
					document.getElementById("loading").style.display = value ? "block": "none" ;
				}

				function createSlider(maxSteps) {
					var rangeSlider = document.getElementById('slider');
					noUiSlider.create(rangeSlider, {
						start: [ 0 ],
						step: 1,
						connect : 'lower',
						range: {
						  'min': 0,
						  'max': maxSteps
						}
					});

					var rangeSliderValueElement = document.getElementById('slider-range-value');

					rangeSlider.noUiSlider.on('update', function( values, handle ) {
						rangeSliderValueElement.innerHTML = parseInt(values[handle]);
					});

					rangeSlider.noUiSlider.on('change', function( values, handle){
						var valueSelected = parseInt(values[handle]);
						sup1.move_to(valueSelected);
						drawImageInCanvas(sup1.get_canvas());
						return false;
					});

				}


				document.getElementById('files').addEventListener('change', handleFileSelect, false);
			</script>


	</body>

</html>
